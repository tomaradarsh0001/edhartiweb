// Minified by Diwakar Sinha at 01-01-2025
const appointmentDateElement=document.getElementById("app_appointment_date"),timeSlotDiv=document.getElementById("app_timeSlotDiv"),meetingTimeElement=document.getElementById("app_meeting_time");if(appointmentDateElement){let e=[],t=[],a=[];const n=4;fetch("/appointments/get-fully-booked-dates").then((e=>e.json())).then((l=>{const s=new Date,o=s.getDay();e=l.fullyBookedDates.filter((e=>new Date(e)>=s)).map((e=>{const t=new Date(e);return new Intl.DateTimeFormat("en-CA",{timeZone:"Asia/Kolkata",year:"numeric",month:"2-digit",day:"2-digit"}).format(t)}));const i={};e.forEach((e=>{const t=new Date(e),a=getStandardWeekNumber(t),n=t.getDay();n>=3&&n<=5&&(i[a]||(i[a]=new Set),i[a].add(n))})),console.log("Fully booked dates:",e);const d=getStandardWeekNumber(s);t=Object.keys(i).filter((e=>{const t=i[e];if(e==d){const e=new Date(s),a=new Date(s),n=new Date(s);e.setDate(s.getDate()-s.getDay()+3),a.setDate(s.getDate()-s.getDay()+4),n.setDate(s.getDate()-s.getDay()+5);return(t.has(3)||isPastEligibleDay(e,s))&&(t.has(4)||isPastEligibleDay(a,s))&&(t.has(5)||isPastEligibleDay(n,s))}return t.has(3)&&t.has(4)&&t.has(5)})),console.log("Fully booked weeks:",t),a=calculateAvailableWeeks(s,o,t,n),console.log("Available weeks:",a);const c=getEndDateFromAvailableWeeks(s,a);flatpickr(appointmentDateElement,{dateFormat:"Y-m-d",minDate:"today",maxDate:c,enable:[function(t){const n=getStandardWeekNumber(t),l=`${t.getFullYear()}-${("0"+(t.getMonth()+1)).slice(-2)}-${("0"+t.getDate()).slice(-2)}`;if(t<s)return!1;const o=t<=c&&t>=s,i=3===t.getDay()||4===t.getDay()||5===t.getDay(),d=e.includes(l),g=a.includes(n);return o&&i&&!d&&g&&t>=s}],onDayCreate:function(t,n,l,s){const o=new Date(s.dateObj),i=new Date;i.setHours(0,0,0,0);const d=`${o.getFullYear()}-${("0"+(o.getMonth()+1)).slice(-2)}-${("0"+o.getDate()).slice(-2)}`;o<=i&&isPastEligibleDay(o,i)&&s.classList.add("past-eligible-day"),o<i&&(s.classList.remove("fully-booked-date"),s.classList.add("flatpickr-disabled"),s.disabled=!0),e.includes(d)&&s.classList.add("fully-booked-date");const c=getStandardWeekNumber(o),g=3===o.getDay()||4===o.getDay()||5===o.getDay(),D=e.includes(d),r=a.includes(c);g&&!D&&r&&o>i&&s.classList.add("available-date")},onChange:function(e,t){t&&fetchAvailableTimeSlots(t)}})})).catch((e=>{console.error("Error fetching fully booked dates:",e)}))}

// Function to calculate the end date from available weeks
// Minified by Diwakar Sinha at 01-01-2025
function getEndDateFromAvailableWeeks(e,t){if(0===t.length)return e;const n=t[t.length-1],a=new Date(e);return a.setDate(e.getDate()+7*(n-getStandardWeekNumber(e))+(6-e.getDay())),a}

// Check if the day is a past eligible day
// Minified by Diwakar Sinha at 01-01-2025
function isPastEligibleDay(e,t){const a=t.getDay(),D=e.getDay(),n=[3,4,5].includes(D),s=e<=t;let g=new Date(t);g.setDate(t.getDate()-a+(0===a?-6:1));let i=new Date(g);return i.setDate(g.getDate()+6),n&&s&&e>=g&&e<=i}

// Minified by Diwakar Sinha at 01-01-2025
function fetchAvailableTimeSlots(e){fetch(`/appointments/get-available-time-slots?date=${e}`).then((e=>e.json())).then((e=>{meetingTimeElement.innerHTML='<option value="">Select a time slot</option>',e.length>0?(e.forEach((e=>{let t=document.createElement("option");t.value=e,t.textContent=e,meetingTimeElement.appendChild(t)})),timeSlotDiv.style.display="block"):timeSlotDiv.style.display="none"})).catch((e=>console.error("Error fetching time slots:",e)))}

// Function to calculate the standard week number (Monday-Sunday)
// Minified by Diwakar Sinha at 01-01-2025
function getStandardWeekNumber(e){const t=new Date(e),a=new Date(t.getFullYear(),0,1),n=t-a,r=Math.floor(n/864e5)+1,l=a.getDay(),o=0===l?1:0;return Math.ceil((r+l-o)/7)}

// Function to calculate available weeks (excluding past and fully booked weeks)
// Minified by Diwakar Sinha at 01-01-2025
function calculateAvailableWeeks(e,t,a,n){let s=[],c=0;t>=5&&(c=1);const l=getStandardWeekNumber(e);for(;s.length<n;){const t=l+c,n=new Date(e);n.setDate(e.getDate()+7*c-e.getDay());const D=new Date(n);D.setDate(n.getDate()+6),!a.includes(String(t))&&D>=e&&s.push(t),c++}return s}

// OTP Input Management Logic
// Minified by Diwakar Sinha at 01-01-2025
const setupForm=(e,t)=>{const n=document.getElementById(e),a=[...n.querySelectorAll("input[type=text]")],l=n.querySelector(t),s=e=>{const t=a.indexOf(e.target);/^[0-9]{1}$/.test(e.key)||"Backspace"===e.key||"Delete"===e.key||"Tab"===e.key||e.metaKey||e.preventDefault(),("Delete"===e.key||"Backspace"===e.key)&&t>=0&&(""===a[t].value?t>0&&(a[t-1].focus(),a[t-1].value=""):a[t].value="",e.preventDefault())},c=e=>{const{target:t}=e,n=a.indexOf(t);t.value&&n<a.length-1?a[n+1].focus():n===a.length-1&&l.focus()},r=e=>{e.target.select()},u=e=>{e.preventDefault();const t=e.clipboardData.getData("text");if(!/^[0-9]{1,}$/.test(t))return;const n=t.split("").slice(0,a.length);a.forEach(((e,t)=>e.value=n[t]||"")),n.length===a.length&&l.focus()};a.forEach((e=>{e.addEventListener("input",c),e.addEventListener("keydown",s),e.addEventListener("focus",r),e.addEventListener("paste",u)}))};

// Initialize setupForm for OTP forms
// Minified by Diwakar Sinha at 01-01-2025
setupForm("app-otp-form","#appVerifyMobileOtpBtn"),setupForm("app-otp-form-email","#appVerifyEmailOtpBtn");var app_meetingPurpose=document.getElementById("app_meetingPurpose");app_meetingPurpose.addEventListener("change",(function(){document.getElementById("app_meetingDescriptionDiv").style.display=""!==this.value?"block":"none"}));

// Appointment Form Validation
// Minified by Diwakar Sinha at 01-01-2025
$(document).ready((function(){function e(){$("#app_Yes").is(":checked")?($("#app_ifyes").show(),$("#app_ifYesNotChecked").hide()):($("#app_ifyes").hide(),$("#app_ifYesNotChecked").show())}function r(){$("#app_isStakeholder").is(":checked")?$("#app_ifStakeholder").show():$("#app_ifStakeholder").hide()}$("#app_AppointmentSubmitButton").click((function(e){e.preventDefault();var r=document.getElementById("appointment_form");(function(){let e=null,r=!0;[{id:"#app_fullname",errorId:"#app_fullnameError"},{id:"#app_mobile",errorId:"#app_mobileError"},{id:"#app_email",errorId:"#app_emailError"},{id:"#app_pan_number",errorId:"#app_panNumberError"}].forEach((function(i){const o=$(i.id),t=$(i.errorId);o.on("input",(function(){""!==o.val().trim()&&(o.removeClass("required"),t.hide())})),""===o.val().trim()?(o.addClass("required"),t.text("This field is required").show(),r=!1,null===e&&(e=o)):(o.removeClass("required"),t.hide())}));const i=$("#app_mobile"),o=$("#app_mobileError"),t=i.attr("data-id");function a(){const a=i.val().trim();""===a?(o.text("Mobile Number is required"),o.show(),r=!1,null===e&&(e=i)):10!==a.length?(o.text("Mobile Number must be exactly 10 digits"),o.show(),r=!1,null===e&&(e=i)):"0"===t?(o.text("Please verify your mobile number"),o.show(),r=!1,null===e&&(e=i)):o.hide()}a(),i.on("input",(function(){""!==i.val().trim()&&(e=null),a()}));const l=$("#app_email"),n=$("#app_emailError"),p=l.val().trim(),d=l.attr("data-id");""===p?(n.text("Email is required"),n.show(),r=!1,null===e&&(e=l)):"0"===d?(n.text("Please verify your email"),n.show(),r=!1,null===e&&(e=l)):n.hide();const s=$("#app_pan_number"),u=$("#app_panNumberError"),m=s.val().trim();""===m?(s.addClass("required"),u.text("This field is required").show(),r=!1,null===e&&(e=s)):10!==m.length?(s.addClass("required"),u.text("PAN Number must be exactly 10 characters").show(),r=!1,null===e&&(e=s)):(s.removeClass("required"),u.hide());if($("#app_Yes").is(":checked")){[{id:"#app_localityFill",errorId:"#app_localityFillError"},{id:"#app_blocknoFill",errorId:"#app_blocknoFillError"},{id:"#app_plotnoFill",errorId:"#app_plotnoFillError"}].forEach((function(i){const o=$(i.id),t=$(i.errorId);o.on("input",(function(){""!==o.val().trim()&&(o.removeClass("required"),t.hide())})),""===o.val().trim()?(o.addClass("required"),t.text("This field is required").show(),r=!1,null===e&&(e=o)):(o.removeClass("required"),t.hide())}))}else{[{id:"#app_locality",errorId:"#app_localityError"},{id:"#app_block",errorId:"#app_blockError"},{id:"#app_plot",errorId:"#app_plotError"}].forEach((function(i){const o=$(i.id),t=$(i.errorId);o.on("input",(function(){""!==o.val().trim()&&(o.removeClass("required"),t.hide())})),""===o.val().trim()?(o.addClass("required"),t.text("This field is required").show(),r=!1,null===e&&(e=o)):(o.removeClass("required"),t.hide())}))}if($("#app_isStakeholder").is(":checked")){const w=$("#app_stakeholderProof"),I=$("#app_stakeholderProofError");function c(){const i=w[0].files;let o=!1,t=!0;if(i.length>0){o=!0;for(let e=0;e<i.length;e++){if(!i[e].name.endsWith(".pdf")){t=!1;break}}}o?t?(w.removeClass("required"),I.hide()):(w.addClass("required"),I.text("Only PDF file is allowed").show(),r=!1,null===e&&(e=w)):(w.addClass("required"),I.text("File is required").show(),r=!1,null===e&&(e=w))}c(),w.on("change",(function(){e=null,c()}))}[{id:"#app_natureOfVisit",errorId:"#app_natureOfVisitError"},{id:"#app_meetingPurpose",errorId:"#app_meetingPurposeError"},{id:"#app_appointment_date",errorId:"#app_appointmentDateError"}].forEach((function(i){const o=$(i.id),t=$(i.errorId);o.on("input",(function(){""!==o.val().trim()&&(o.removeClass("required"),t.hide())})),""===o.val().trim()?(o.addClass("required"),t.text("This field is required").show(),r=!1,null===e&&(e=o)):(o.removeClass("required"),t.hide())}));const h=$("#app_meetingPurpose"),_=$("#app_meetingDescription"),f=$("#app_meetingDescriptionError");function v(){const i=h.val().trim(),o=_.val().trim();""!==i&&""===o?(f.text("Meeting Description is required"),f.show(),_.addClass("required"),r=!1,null===e&&(e=_)):(f.hide(),_.removeClass("required"))}v(),h.on("input",v),_.on("input",(function(){""!==_.val().trim()&&(e=null),v()}));const q=$("#app_appointment_date"),E=$("#app_meeting_time"),b=q.val().trim(),C=E.val().trim(),k=$("#app_meetingTimeError");""!==b&&""===C?(k.text("Time Slot is required"),k.show(),E.addClass("required"),r=!1,null===e&&(e=E)):(k.hide(),E.removeClass("required"));null!==e&&e.focus();return r})()&&r.submit()})),e(),$("#app_Yes").change((function(){e()})),r(),$("#app_isStakeholder").change((function(){r()}))}));